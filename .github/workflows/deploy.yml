name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."

            # Navigate to project directory
            cd /home/ubuntu/revize_v2

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            # Create production environment file
            echo "ğŸ“ Creating environment file..."
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > spaced-repetition/.env.prod
            echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> spaced-repetition/.env.prod
            echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> spaced-repetition/.env.prod
            echo "CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}" >> spaced-repetition/.env.prod
            echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> spaced-repetition/.env.prod
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> spaced-repetition/.env.prod
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> spaced-repetition/.env.prod
            echo "GOOGLE_OAUTH2_CLIENT_ID=${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}" >> spaced-repetition/.env.prod
            echo "GOOGLE_OAUTH2_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}" >> spaced-repetition/.env.prod
            echo "USE_S3=${{ secrets.USE_S3 }}" >> spaced-repetition/.env.prod
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> spaced-repetition/.env.prod
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> spaced-repetition/.env.prod
            echo "AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME }}" >> spaced-repetition/.env.prod
            echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> spaced-repetition/.env.prod
            echo "LANGSMITH_TRACING=${{ secrets.LANGSMITH_TRACING }}" >> spaced-repetition/.env.prod
            echo "LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" >> spaced-repetition/.env.prod
            echo "LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }}" >> spaced-repetition/.env.prod

            # Navigate to spaced-repetition directory
            cd spaced-repetition

            # Build Docker images (using --env-file to pass variables)
            echo "ğŸ”¨ Building Docker images..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml build --no-cache

            # Stop existing containers
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml down || true

            # Start new containers
            echo "ğŸš€ Starting new containers..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml up -d

            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 30

            # Check container status
            echo "ğŸ“Š Container status:"
            docker compose --env-file .env.prod -f docker-compose.prod.yml ps

            # Health check
            echo "ğŸ¥ Running health check..."
            curl -f http://localhost:8000/api/health/ && echo "âœ… Backend healthy" || echo "âš ï¸ Backend health check pending"
            curl -f http://localhost:80/ && echo "âœ… Frontend healthy" || echo "âš ï¸ Frontend health check pending"

            # Clean up old images
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "âœ… Deployment completed successfully!"

      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
