name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."

            # Navigate to project directory
            cd /home/ubuntu/revize_v2

            # Pull latest changes
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main

            # Create production environment file
            echo "ðŸ“ Creating environment file..."
            cat > spaced-repetition/.env.prod << ENVEOF
DATABASE_URL=${{ secrets.DATABASE_URL }}
DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
VITE_API_URL=${{ secrets.VITE_API_URL }}
GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
GOOGLE_OAUTH2_CLIENT_ID=${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
GOOGLE_OAUTH2_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
USE_S3=${{ secrets.USE_S3 }}
AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME }}
AWS_REGION=${{ secrets.AWS_REGION }}
LANGSMITH_TRACING=${{ secrets.LANGSMITH_TRACING }}
LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}
LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }}
ENVEOF

            # Navigate to spaced-repetition directory
            cd spaced-repetition

            # Build Docker images (using --env-file to pass variables)
            echo "ðŸ”¨ Building Docker images..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml build --no-cache

            # Stop existing containers
            echo "ðŸ›‘ Stopping existing containers..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml down || true

            # Start new containers
            echo "ðŸš€ Starting new containers..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml up -d

            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 30

            # Check container status
            echo "ðŸ“Š Container status:"
            docker compose --env-file .env.prod -f docker-compose.prod.yml ps

            # Health check
            echo "ðŸ¥ Running health check..."
            curl -f http://localhost:8000/api/health/ && echo "âœ… Backend healthy" || echo "âš ï¸ Backend health check pending"
            curl -f http://localhost:80/ && echo "âœ… Frontend healthy" || echo "âš ï¸ Frontend health check pending"

            # Clean up old images
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "âœ… Deployment completed successfully!"

      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
